<template>
  <a-modal
    v-model:open="modalOpen"
    title="å¦‡äº§ç§‘ç—…ä¾‹å­¦æœ¯ä»·å€¼åˆ†æç³»ç»Ÿ"
    width="1200px"
    :footer="null"
    :bodyStyle="{ maxHeight: 'calc(100vh - 200px)', overflowY: 'auto' }"
  >
    <a-row :gutter="16">
      <a-col :span="10">
        <a-card title="ç—…ä¾‹ä¿¡æ¯å½•å…¥" size="small" style="margin-bottom: 16px;">
          <a-form layout="vertical" :model="localCase">
            <a-form-item label="æ‚£è€…å§“å" required>
              <a-input v-model:value="localCase.name" placeholder="è¯·è¾“å…¥æ‚£è€…å§“å" />
            </a-form-item>
            
            <a-row :gutter="12">
              <a-col :span="12">
                <a-form-item label="æ€§åˆ«">
                  <a-select v-model:value="localCase.gender" placeholder="è¯·é€‰æ‹©æ€§åˆ«">
                    <a-select-option value="female">å¥³</a-select-option>
                    <a-select-option value="male">ç”·</a-select-option>
                    <a-select-option value="other">å…¶ä»–</a-select-option>
                  </a-select>
                </a-form-item>
              </a-col>
              <a-col :span="12">
                <a-form-item label="å¹´é¾„">
                  <a-input-number
                    v-model:value="localCase.age"
                    :min="0"
                    :max="120"
                    style="width: 100%"
                    placeholder="å¹´é¾„"
                  />
                </a-form-item>
              </a-col>
            </a-row>

            <a-form-item label="æœˆç»å²">
              <a-textarea
                v-model:value="localCase.menstrualHistory"
                :rows="2"
                placeholder="ä¾‹ï¼šLMP 2024-01-15ï¼ŒG3P2A0ï¼Œæœˆç»è§„å¾‹"
              />
            </a-form-item>

            <a-form-item label="å©šè‚²å²">
              <a-textarea
                v-model:value="localCase.marriageHistory"
                :rows="2"
                placeholder="ä¾‹ï¼šå·²å©šï¼Œè‚²æœ‰2å­ï¼Œæ— æµäº§å²"
              />
            </a-form-item>

            <a-form-item label="æ—¢å¾€å¦‡ç§‘ç—…å²">
              <a-textarea
                v-model:value="localCase.pastHistory"
                :rows="2"
                placeholder="ä¾‹ï¼š5å¹´å‰è¡Œå­å®«è‚Œç˜¤å‰”é™¤æœ¯"
              />
            </a-form-item>

            <a-form-item label="ä¸»è¯‰" required>
              <a-textarea
                v-model:value="localCase.currentProblem"
                :rows="3"
                placeholder="ä¾‹ï¼šé—´æ–­æ€§é˜´é“æµè¡€3æœˆï¼Œä¼´ä¸‹è…¹ç—›1å‘¨"
              />
            </a-form-item>

            <a-form-item label="ä½“æ ¼æ£€æŸ¥ä¸è¾…åŠ©æ£€æŸ¥">
              <a-textarea
                v-model:value="localCase.examination"
                :rows="3"
                placeholder="ä¾‹ï¼šå¦‡ç§‘æ£€æŸ¥ï¼šå®«é¢ˆå…‰æ»‘ï¼Œå®«ä½“å¢å¤§å¦‚å­•8å‘¨ï¼Œè´¨éŸ§ï¼Œæ´»åŠ¨å¯ï¼›å®éªŒå®¤ï¼šHCG 5000 mIU/mlï¼ŒCA125 45 U/ml"
              />
            </a-form-item>

            <a-form-item label="å½±åƒå­¦æ£€æŸ¥ç»“æœ">
              <a-textarea
                v-model:value="localCase.imageRecognitionResult"
                :rows="2"
                placeholder="ä¾‹ï¼šè¶…å£°æç¤ºå­å®«å‰å£5cmä½å›å£°å›¢å—ï¼Œè¾¹ç•Œæ¸…ï¼ŒCDFIç¤ºå‘¨è¾¹è¡€æµä¿¡å·"
              />
            </a-form-item>

            <a-form-item label="è¯Šæ–­">
              <a-textarea
                v-model:value="localCase.diagnosis"
                :rows="2"
                placeholder="ä¾‹ï¼šå­å®«è‚Œç˜¤ï¼ˆæµ†è†œä¸‹å‹ï¼‰ï¼Œç»§å‘è´«è¡€"
              />
            </a-form-item>

            <a-form-item label="æ²»ç–—æ–¹æ¡ˆ">
              <a-textarea
                v-model:value="localCase.treatment"
                :rows="3"
                placeholder="ä¾‹ï¼šè…¹è…”é•œä¸‹å­å®«è‚Œç˜¤å‰”é™¤æœ¯ï¼Œæœ¯ä¸­é‡‡ç”¨æ”¹è‰¯æ­¢è¡€æŠ€æœ¯ï¼Œæœ¯åGnRH-aç±»ä¼¼ç‰©3ä¸ªæœˆ"
              />
            </a-form-item>

            <a-form-item label="æ²»ç–—æ•ˆæœ">
              <a-textarea
                v-model:value="localCase.outcome"
                :rows="2"
                placeholder="ä¾‹ï¼šæœ¯åæ¢å¤è‰¯å¥½ï¼Œæœˆç»æ¢å¤æ­£å¸¸ï¼Œæœ¯å6æœˆå¤æŸ¥æœªè§å¤å‘"
              />
            </a-form-item>

            <a-form-item label="éšè®¿æƒ…å†µ">
              <a-textarea
                v-model:value="localCase.followUp"
                :rows="2"
                placeholder="ä¾‹ï¼šæœ¯å12æœˆéšè®¿ï¼Œæ‚£è€…è‡ªç„¶å—å­•å¹¶è¶³æœˆé¡ºäº§ä¸€ç”·å©´"
              />
            </a-form-item>
          </a-form>

          <a-space style="width: 100%; justify-content: space-between">
            <a-space>
              <a-button type="primary" @click="startAnalysis" :loading="isAnalyzing" :disabled="!canAnalyze">
                {{ isAnalyzing ? 'åˆ†æä¸­...' : 'å¼€å§‹åˆ†æ' }}
              </a-button>
              <a-button @click="clearForm">æ¸…ç©º</a-button>
            </a-space>
            <a-button @click="loadFromConsult" v-if="hasConsultData">ä»å½“å‰ä¼šè¯Šå¯¼å…¥</a-button>
          </a-space>
        </a-card>

        <a-card title="åˆ†æåŒ»ç”Ÿé€‰æ‹©" size="small">
          <a-select
            v-model:value="selectedDoctorId"
            style="width: 100%"
            placeholder="è¯·é€‰æ‹©ä¸€ä½AIåŒ»ç”Ÿè¿›è¡Œåˆ†æ"
            :options="doctorOptions"
          />
          <div v-if="selectedDoctorId" style="margin-top: 8px; color: #8c8c8c; font-size: 12px;">
            å·²é€‰æ‹©ï¼š{{ selectedDoctorName }}
          </div>
        </a-card>
      </a-col>

      <a-col :span="14">
        <a-card title="å­¦æœ¯ä»·å€¼åˆ†æç»“æœ" size="small" style="height: 100%;">
          <div v-if="store.analysisResult.status === 'idle'" style="text-align: center; padding: 60px 20px; color: #8c8c8c;">
            <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">ğŸ“„</div>
            <div>è¯·å¡«å†™ç—…ä¾‹ä¿¡æ¯å¹¶é€‰æ‹©åŒ»ç”Ÿåå¼€å§‹åˆ†æ</div>
          </div>

          <div v-else-if="store.analysisResult.status === 'analyzing'" style="text-align: center; padding: 60px 20px;">
            <a-spin size="large" tip="AIæ­£åœ¨æ·±åº¦åˆ†æç—…ä¾‹çš„å­¦æœ¯ä»·å€¼ä¸åˆ›æ–°æ€§ï¼Œè¯·ç¨å€™..." />
          </div>

          <div v-else-if="store.analysisResult.status === 'error'" style="padding: 20px;">
            <a-alert type="error" show-icon :message="store.analysisResult.content" />
          </div>

          <div v-else-if="store.analysisResult.status === 'completed'" ref="resultRef">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <a-tag color="success">åˆ†æå®Œæˆ</a-tag>
                <span style="color: #8c8c8c; font-size: 12px;">
                  ç”± {{ store.analysisResult.doctorName }} ç”Ÿæˆ Â· {{ formatTime(store.analysisResult.timestamp) }}
                </span>
              </div>
              <a-button type="dashed" size="small" @click="exportResultImage">å¯¼å‡ºå›¾ç‰‡</a-button>
            </div>

            <div class="analysis-result-container">
              <div class="result-header">
                <h3>ğŸ”¬ å¦‡äº§ç§‘ç—…ä¾‹å­¦æœ¯ä»·å€¼åˆ†ææŠ¥å‘Š</h3>
                <div class="patient-brief">
                  <strong>{{ localCase.name || 'æœªå‘½åæ‚£è€…' }}</strong>
                  <span v-if="localCase.gender">ï¼ˆ{{ genderText }}ï¼‰</span>
                  <span v-if="localCase.age !== null && localCase.age !== undefined">ï¼Œ{{ localCase.age }}å²</span>
                </div>
              </div>
              
              <div v-html="renderMarkdown(store.analysisResult.content)" class="markdown-content"></div>
            </div>
          </div>
        </a-card>

        <a-card v-if="hasHistory" title="åˆ†æå†å²" size="small" style="margin-top: 16px;">
          <a-list :data-source="store.analysisHistory.slice().reverse()" size="small">
            <template #renderItem="{ item }">
              <a-list-item>
                <template #actions>
                  <a @click="loadHistory(item.id)">æŸ¥çœ‹</a>
                  <a-popconfirm title="ç¡®è®¤åˆ é™¤ï¼Ÿ" @confirm="deleteHistory(item.id)">
                    <a style="color: #ff4d4f;">åˆ é™¤</a>
                  </a-popconfirm>
                </template>
                <a-list-item-meta>
                  <template #title>
                    {{ item.patientCase.name || 'æœªå‘½åæ‚£è€…' }}
                  </template>
                  <template #description>
                    {{ formatTime(item.timestamp) }} Â· ç”± {{ item.doctorName }} åˆ†æ
                  </template>
                </a-list-item-meta>
              </a-list-item>
            </template>
          </a-list>
        </a-card>
      </a-col>
    </a-row>
  </a-modal>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { marked } from 'marked'
import { message } from 'ant-design-vue'
import { useCaseAnalysisStore } from '../store/caseAnalysis'
import { useGlobalStore } from '../store/global'
import { useConsultStore } from '../store'

const props = defineProps({
  open: { type: Boolean, default: false }
})
const emit = defineEmits(['update:open'])

const store = useCaseAnalysisStore()
const globalStore = useGlobalStore()
const consultStore = useConsultStore()

const modalOpen = ref(props.open)
const localCase = ref({ ...store.patientCase })
const selectedDoctorId = ref(store.selectedDoctor ? store.selectedDoctor.id : null)
const resultRef = ref(null)

watch(() => props.open, (v) => {
  modalOpen.value = v
  if (v) {
    localCase.value = { ...store.patientCase }
    selectedDoctorId.value = store.selectedDoctor ? store.selectedDoctor.id : null
  }
})

watch(modalOpen, (v) => emit('update:open', v))

watch(localCase, (value) => {
  store.setPatientCase(value)
}, { deep: true })

watch(selectedDoctorId, (id) => {
  const doctor = globalStore.doctors.find((d) => d.id === id)
  store.setSelectedDoctor(doctor || null)
})

const doctorOptions = computed(() => {
  return globalStore.doctors.map((d) => ({
    label: `${d.name}ï¼ˆ${d.provider} Â· ${d.model}ï¼‰`,
    value: d.id
  }))
})

const selectedDoctorName = computed(() => {
  const doctor = globalStore.doctors.find((d) => d.id === selectedDoctorId.value)
  return doctor ? doctor.name : ''
})

const isAnalyzing = computed(() => store.isAnalyzing)

const canAnalyze = computed(() => {
  return selectedDoctorId.value && localCase.value.name && localCase.value.currentProblem
})

const hasConsultData = computed(() => {
  return consultStore.patientCase && consultStore.patientCase.name && consultStore.patientCase.currentProblem
})

const hasHistory = computed(() => store.analysisHistory && store.analysisHistory.length > 0)

const genderText = computed(() => {
  const genderMap = { male: 'ç”·', female: 'å¥³', other: 'å…¶ä»–' }
  return genderMap[localCase.value.gender] || localCase.value.gender || ''
})

async function startAnalysis() {
  if (!canAnalyze.value) {
    message.warning('è¯·å¡«å†™æ‚£è€…å§“åã€ä¸»è¯‰ï¼Œå¹¶é€‰æ‹©åˆ†æåŒ»ç”Ÿ')
    return
  }

  try {
    store.setPatientCase(localCase.value)
    const doctor = globalStore.doctors.find((d) => d.id === selectedDoctorId.value)
    store.setSelectedDoctor(doctor)
    await store.analyzeCase()
    message.success('åˆ†æå®Œæˆï¼')
  } catch (error) {
    message.error('åˆ†æå¤±è´¥ï¼š' + (error.message || error))
  }
}

function clearForm() {
  localCase.value = {
    name: '',
    gender: '',
    age: null,
    menstrualHistory: '',
    marriageHistory: '',
    pastHistory: '',
    currentProblem: '',
    imageRecognitionResult: '',
    examination: '',
    diagnosis: '',
    treatment: '',
    outcome: '',
    followUp: ''
  }
  store.clearCase()
}

function loadFromConsult() {
  const consultCase = consultStore.patientCase
  localCase.value = {
    name: consultCase.name || '',
    gender: consultCase.gender || '',
    age: consultCase.age,
    menstrualHistory: consultCase.menstrualHistory || '',
    marriageHistory: consultCase.marriageHistory || '',
    pastHistory: consultCase.pastHistory || '',
    currentProblem: consultCase.currentProblem || '',
    imageRecognitionResult: consultCase.imageRecognitionResult || '',
    examination: '',
    diagnosis: '',
    treatment: '',
    outcome: '',
    followUp: ''
  }
  
  if (consultStore.finalSummary && consultStore.finalSummary.content) {
    localCase.value.diagnosis = consultStore.finalSummary.content
  }
  
  message.success('å·²ä»å½“å‰ä¼šè¯Šå¯¼å…¥ç—…ä¾‹ä¿¡æ¯')
}

function loadHistory(historyId) {
  store.loadFromHistory(historyId)
  localCase.value = { ...store.patientCase }
  message.success('å·²åŠ è½½å†å²åˆ†æè®°å½•')
}

function deleteHistory(historyId) {
  store.deleteFromHistory(historyId)
  message.success('å·²åˆ é™¤')
}

function formatTime(timestamp) {
  if (!timestamp) return ''
  const date = new Date(timestamp)
  const pad = (n) => String(n).padStart(2, '0')
  return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`
}

function renderMarkdown(text) {
  try {
    return marked.parse(text || '')
  } catch (e) {
    return text
  }
}

async function exportResultImage() {
  const node = resultRef.value
  if (!node) return
  try {
    const dataUrl = await window.htmlToImage.toPng(node, { pixelRatio: 2, cacheBust: true })
    const a = document.createElement('a')
    const fileName = localCase.value.name ? `${localCase.value.name}-ç—…ä¾‹å­¦æœ¯ä»·å€¼åˆ†æ` : 'ç—…ä¾‹å­¦æœ¯ä»·å€¼åˆ†æ'
    a.href = dataUrl
    a.download = `${fileName}.png`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
  } catch (e) {
    message.error('å¯¼å‡ºå¤±è´¥')
    console.error(e)
  }
}
</script>

<style scoped>
.analysis-result-container {
  background: #ffffff;
  border: 1px solid #e6f4ff;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.result-header {
  border-bottom: 2px solid #1890ff;
  padding-bottom: 12px;
  margin-bottom: 20px;
}

.result-header h3 {
  margin: 0 0 8px 0;
  color: #0958d9;
  font-size: 18px;
  font-weight: 600;
}

.patient-brief {
  color: #595959;
  font-size: 14px;
}

.markdown-content {
  line-height: 1.8;
}

.markdown-content :deep(h1),
.markdown-content :deep(h2),
.markdown-content :deep(h3),
.markdown-content :deep(h4) {
  margin: 20px 0 12px;
  color: #262626;
}

.markdown-content :deep(h1) {
  font-size: 24px;
  border-bottom: 2px solid #f0f0f0;
  padding-bottom: 8px;
}

.markdown-content :deep(h2) {
  font-size: 20px;
  color: #1890ff;
}

.markdown-content :deep(h3) {
  font-size: 16px;
  color: #1890ff;
}

.markdown-content :deep(p) {
  margin: 8px 0;
  color: #595959;
}

.markdown-content :deep(ul),
.markdown-content :deep(ol) {
  padding-left: 24px;
  margin: 8px 0;
}

.markdown-content :deep(li) {
  margin: 4px 0;
  color: #595959;
}

.markdown-content :deep(strong) {
  color: #262626;
  font-weight: 600;
}

.markdown-content :deep(code) {
  background: #f5f5f5;
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
  color: #d4380d;
}

.markdown-content :deep(blockquote) {
  border-left: 4px solid #1890ff;
  padding-left: 12px;
  margin: 12px 0;
  color: #8c8c8c;
  font-style: italic;
}

.markdown-content :deep(table) {
  width: 100%;
  border-collapse: collapse;
  margin: 12px 0;
}

.markdown-content :deep(th),
.markdown-content :deep(td) {
  border: 1px solid #f0f0f0;
  padding: 8px 12px;
  text-align: left;
}

.markdown-content :deep(th) {
  background: #fafafa;
  font-weight: 600;
  color: #262626;
}
</style>
